# 🛡️ 負の連鎖防止ガイド

## なぜ「修正が更なる修正を呼ぶ」のか

### 根本原因
1. **変更の影響範囲が不明確** - 1箇所を変えると他の場所に影響
2. **テストが画面表示を検証していなかった** - 構文OKでも指標が消える
3. **翻訳キーの保護がなかった** - 重要なキーが知らぬ間に消える

---

## 🛡️ 新しい防御システム（2026-01-25導入）

### レベル1: 指標カウントテスト
**ファイル**: `tests/test_indicator_display.py`

各ページの `show_metric_with_sparkline` 呼び出し回数を監視。
期待値を下回るとcommitを拒否。

```
01_liquidity.py: 最低14回
03_us_economic.py: 最低10回
...
```

**これが検出する問題**:
- ❌ 指標表示コードの誤削除
- ❌ セクション全体の書き換えによる消失
- ❌ リファクタリング時の漏れ

### レベル2: 重要翻訳キーテスト
**ファイル**: `tests/test_i18n.py`

UIに必須のキー（`data_period`, `source_update_date`等）の存在を確認。

**これが検出する問題**:
- ❌ 翻訳ファイル編集時のキー削除
- ❌ 言語間のキー不一致

### レベル3: pre-commitフック
**ファイル**: `.git/hooks/pre-commit`

commit前に自動で4つのテストを実行:
1. i18nテスト（翻訳キー）
2. **指標表示テスト（NEW）**
3. アプリ健全性テスト
4. ヘルスチェック

**失敗したらcommit拒否 → 問題が本番に入らない**

---

## 📋 修正時のワークフロー

### BEFORE（今まで）
```
修正 → commit → push → 問題発覚 → また修正 → commit...
```

### AFTER（新ワークフロー）
```
修正 → git add → git commit → テスト自動実行
                              ↓
                        NG: 指標が減った！
                              ↓
                        commit拒否 → 修正を確認
                              ↓
                        OK: commit成功 → push
```

---

## 🔧 Claudeへの依頼方法

### ❌ NGな依頼
- 「この関数を書き換えて」
- 「このセクションを効率化して」
- 「コードを整理して」

### ✅ OKな依頼
- 「○○だけを変更して（他は絶対触らないで）」
- 「行XXXの△△を□□に変えて」
- 「新しい指標を追加して（既存は触らないで）」

---

## 🚨 問題が起きたときの対処

### 症状1: 指標が消えた
```bash
# 1. テストを実行して確認
python tests/test_indicator_display.py

# 2. 最新の正常なcommitに戻す
git log --oneline
git checkout <正常なcommit> -- pages/XX_YYY.py
```

### 症状2: 翻訳が消えた
```bash
# 1. テストを実行
python tests/test_i18n.py

# 2. 不足キーを確認して追加
```

### 症状3: commitできない
```
テストが失敗 → 失敗理由を確認 → 修正 → 再commit
```

---

## 📊 期待値の更新方法

新しい指標を追加したら、テストの期待値も更新:

```python
# tests/test_indicator_display.py
EXPECTED_MIN_METRICS = {
    '01_liquidity.py': {
        'show_metric_with_sparkline': 14,  # ← +1する
    },
    ...
}
```

---

## 🎯 これで防げること

| 問題 | 以前 | 現在 |
|------|------|------|
| 指標の消失 | 気づかない | commit時に検出 |
| 翻訳キー消失 | 気づかない | commit時に検出 |
| テスト忘れ | 手動なので忘れる | 自動実行 |
| 問題の本番流出 | 起きる | commit拒否で防止 |

---

## 📝 まとめ

**「修正が更なる修正を呼ぶ」を防ぐ3原則**:

1. **外科的修正のみ** - 必要な箇所だけ変更
2. **テスト期待値を維持** - 指標数が減ったら警告
3. **pre-commitフック信頼** - テスト失敗ならcommitしない

これで、安心して修正・機能追加ができます！
